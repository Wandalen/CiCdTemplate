
name : status_checks_rules_update

on : [ workflow_dispatch ]

concurrency :

  group : projected_rules_update
  cancel-in-progress : true

jobs :

  update :
    runs-on : ubuntu-latest
    steps :
      - uses: actions/checkout@v2
      - name : Get options
        id : options_get
        run : |
          WORKFLOWS=$(ls .github/workflows | grep Module)
          for WORKFLOW in $WORKFLOWS ; do
          CONTEXT=$(echo $WORKFLOW | sed 's/\(\S\+\).yml/{"context":"check (\1)","app_id":null}/')
            CONTEXTS="$CONTEXTS,$CONTEXT"
          done;
          CONTEXTS=$(sed 's/^,//g' <<< $CONTEXTS)
          CHECKS="[$CONTEXTS,{\"context\":\"merge\",\"app_id\":null}]"
          echo "::set-output name=options::{\"required_status_checks\":{\"strict\":false,\"checks\":$CHECKS},\"enforce_admins\":false,\"required_pull_request_reviews\":null,\"restrictions\":null}"
      - name : Setup rules
        run : |
          curl -X PUT \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: token ${{ secrets.PRIVATE_GITHUB_BOT_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/branches/beta/protection \
          -d '${{ steps.options_get.outputs.options }}'
